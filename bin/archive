#!/bin/bash

set -e

basedir=$PWD

echo ">>> Compacting repos..." 
for dir in $(fd -HIg --type d .git "$1"); do
  gitdir=$(dirname "$dir")
  cd "$gitdir"
  git gc
  cd "$basedir"
done

echo ">>> Creating archive..." 
tar cf - "$1" | xz --verbose -T0 > "$1.tar.xz"

echo ">>> Done" 
