#!/bin/bash

# ============================================================================
# Color Setup
# ============================================================================

if [[ -t 1 ]]; then
  COLOR_GREEN='\033[1;32m'
  COLOR_BLUE='\033[1;34m'
  COLOR_RED='\033[1;31m'
  COLOR_YELLOW='\033[1;33m'
  COLOR_RESET='\033[0m'
else
  COLOR_GREEN=''
  COLOR_BLUE=''
  COLOR_RED=''
  COLOR_YELLOW=''
  COLOR_RESET=''
fi

# ============================================================================
# Environment Setup
# ============================================================================

export DOTFILES="${HOME}/.dotfiles"

export XDG_CACHE_HOME="${XDG_CACHE_HOME:-${HOME}/.cache}"
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}"
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-${TMPDIR}}"

export ZDATADIR="${XDG_DATA_HOME}/zsh"
export ZCACHEDIR="${XDG_CACHE_HOME}/zsh"
export ZCONFDIR="${XDG_CONFIG_HOME}.local/zsh"
export ZPLUGDIR="${ZDATADIR}/plugins"
export ZFUNCDIR="${ZDATADIR}/functions"
export ZCOMPDIR="${ZCACHEDIR}/completions"

export HOMEBREW_AUTO_UPDATE_SECS=300

INSTALL=0
GROUP=""

if [[ $OSTYPE == linux* ]]; then
  export HOMEBREW_BASE=/home/linuxbrew/.linuxbrew
else
  export HOMEBREW_BASE=/opt/homebrew
fi

PATH="${HOMEBREW_BASE}/bin:${PATH}"
BREW="${HOMEBREW_BASE}/bin/brew"

# ============================================================================
# Utility Functions
# ============================================================================

# Log output
log() {
  local msg="$1"
  local color="${2:-${COLOR_GREEN}}"
  echo -e "${color}>>>${COLOR_RESET} ${msg}"
}

# Log sub-output
logSub() {
  log "$1" "${COLOR_BLUE}"
}

# Log error output
err() {
  log "$1" "${COLOR_RED}"
}

# Log warning output
warn() {
  log "$1" "${COLOR_YELLOW}"
}

# Get a file owner
owner() {
  if [[ $OSTYPE == darwin* ]]; then
    stat -f '%Su' "$1"
  else
    stat -c '%U' "$1"
  fi
}

# Create a directory
makedir() {
  if [[ ! -d "$1" ]]; then
    mkdir -p "$1"
    logSub "Created $1/"
  fi
}

# Create a symlink
link() {
  if [[ ! -r "$2" ]]; then
    ln -s "$1" "$2"
    logSub "Linked $1 -> $2"
  fi
}

# Sed in place (platform-agnostic)
sedInPlace() {
  if [[ $OSTYPE == darwin* ]]; then
    sed -i "" "$@"
  else
    sed -i"" "$@"
  fi
}

# Check if command exists
command_exists() {
  command -v "$1" &> /dev/null
}

# Fix terminal config
fixterm() {
  # Fix terminal definition so C-H works properly in neovim
  local kbs
  kbs=$(infocmp | grep -o 'kbs=[^,]\+')
  if [[ $kbs =~ kbs=\^[hH] ]]; then
    infocmp "$TERM" | sed 's/kbs=^[hH]/kbs=\\177/' > "/tmp/${TERM}.ti"
    tic "/tmp/${TERM}.ti"
    rm "/tmp/${TERM}.ti"
    logSub "Fixed backspace code in terminfo"
  fi
}

# ============================================================================
# Group Functions
# ============================================================================

# Rebuild bat cache
dotfiles-bat() {
  if ! command_exists bat; then
    if [[ $INSTALL == 0 ]]; then
      warn "Bat not installed"
      return
    fi

    brew install bat
  fi

  log "Rebuilding bat cache..."
  local out
  if ! out=$(bat cache --build 2>&1); then
    err "Error rebuilding bat cache"
    err "$out"
  fi
}

# Setup the fish shell prompt
dotfiles-fish() {
  if ! command_exists fish; then
    if [[ $INSTALL == 0 ]]; then
      warn "Fish not installed"
      return
    fi

    if [[ $OSTYPE == linux* ]] && command_exists apt; then
      echo 'deb http://download.opensuse.org/repositories/shells:/fish:/release:/3/Debian_12/ /' | sudo tee /etc/apt/sources.list.d/shells:fish:release:3.list
      curl -fsSL https://download.opensuse.org/repositories/shells:fish:release:3/Debian_12/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/shells_fish_release_3.gpg > /dev/null
      sudo apt update
      sudo apt install fish
    elif [[ $OSTYPE == darwin* ]] && command_exists brew; then
      brew install fish
    else
      err "Unable to install fish"
      return
    fi
  fi

  log "Updating fish config..."
  UV_VENV_CLEAR=1 fish -c configure
}

# Link dotfiles into $HOME, update terminfo
dotfiles-home() {
  log "Updating home directory files..."

  # Remove broken links from home directory
  while IFS= read -r -d '' f; do
    if [[ -L "$f" ]] && [[ ! -e "$f" ]]; then
      rm "$f"
      logSub "Removed $f"
    fi
  done < <(find "${HOME}" -maxdepth 1 -name '.*' -type l -print0 2>/dev/null)

  # Remove broken links from config directory
  if [[ -d "${XDG_CONFIG_HOME}" ]]; then
    while IFS= read -r -d '' f; do
      if [[ -L "$f" ]] && [[ ! -e "$f" ]]; then
        rm "$f"
        logSub "Removed $f"
      fi
    done < <(find "${XDG_CONFIG_HOME}" -maxdepth 1 -type l -print0 2>/dev/null)
  fi

  # Link files from home/ directory
  for f in "${DOTFILES}/home/"*; do
    [[ -e "$f" ]] || continue
    [[ -f "$f" ]] || continue
    local basename
    basename=$(basename "$f")
    link "$f" "${HOME}/.${basename}"
  done

  makedir "${XDG_CONFIG_HOME}"

  # Link directories from config/ directory
  for f in "${DOTFILES}/config/"*; do
    [[ -e "$f" ]] || continue
    local basename
    basename=$(basename "$f")
    
    if [[ -d "${XDG_CONFIG_HOME}/${basename}" ]] && [[ ! -L "${XDG_CONFIG_HOME}/${basename}" ]]; then
      mkdir -p "${XDG_CONFIG_HOME}/local"
      mv "${XDG_CONFIG_HOME}/${basename}" "${XDG_CONFIG_HOME}/local/${basename}"
      logSub "Moved ${XDG_CONFIG_HOME}/${basename} -> ${XDG_CONFIG_HOME}/local/${basename}"
    fi
    link "$f" "${XDG_CONFIG_HOME}/${basename}"
  done

  makedir "${XDG_CACHE_HOME}/zsh"
  makedir "${XDG_CACHE_HOME}/direnv/allow"

  # Fix the terminal definition so that C-H works properly in neovim.
  fixterm

  # Update Hammerspoon config file location on macOS
  if [[ $OSTYPE == darwin* ]] && [[ -d "/Applications/Hammerspoon.app" ]]; then
    local val
    val=$(defaults read org.hammerspoon.Hammerspoon MJConfigFile 2> /dev/null || echo "")
    if [[ "$val" != "$HOME/.config/hammerspoon/init.lua" ]]; then
      defaults write org.hammerspoon.Hammerspoon MJConfigFile "$HOME/.config/hammerspoon/init.lua"
      logSub "Updated Hammerspoon config file location"
    fi
  fi
}

# Upgrade Mac App Store packages
dotfiles-mas() {
  if ! command_exists mas; then
    if [[ $INSTALL == 0 ]]; then
      warn "mas not installed"
      return
    fi

    brew install mas
  fi

  log "Upgrading Mac App Store apps..."
  mas upgrade
}

# Link and activate launchd scripts
dotfiles-launchd() {
  log "Linking and bootstrapping launchd scripts..."

  mkdir -p "${HOME}/Library/LaunchAgents"

  for f in "${DOTFILES}/launchd/"*; do
    [[ -e "$f" ]] || continue
    local basename
    basename=$(basename "$f")
    
    if [[ ! -h "${HOME}/Library/LaunchAgents/${basename}" ]]; then
      link "$f" "${HOME}/Library/LaunchAgents/${basename}"
      launchctl bootstrap "gui/${UID}" "${HOME}/Library/LaunchAgents/${basename}"
      logSub "Bootstrapped ${basename}"
    fi
  done
}

# Install or update rust
dotfiles-rust() {
  if ! command_exists rustup; then
    if [[ $INSTALL == 0 ]]; then
      warn "Rust not installed"
      return
    fi

    log "Installing rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
  else
    log "Updating rust..."
    rustup -q update
  fi
}

# Install homebrew and core packages, update brew packages
dotfiles-brew() {
  if [[ ! -x "$BREW" ]]; then
    if [[ $INSTALL == 0 ]]; then
      warn "Homebrew not installed"
      return
    fi

    logSub "Installing Homebrew..."

    if [[ $OSTYPE == linux* ]]; then
      if ! id linuxbrew > /dev/null 2>&1; then
        sudo adduser --disabled-password --gecos "" linuxbrew
      fi

      sudo -u linuxbrew NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      sudo apt install build-essential

      sudo chmod a+rx /home/linuxbrew
      sudo chmod -R o=u-w "$HOMEBREW_BASE"
    else
      NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
  fi

  # Install some missing or newer core packages from brew
  logSub "Installing/updating core packages..."
  local brew_packages=(
    'bat'        # better cat
    'eza'        # better ls
    'fd'         # file finder
    'ripgrep'    # better grep
    'zoxide'     # better cd
    'mise'       # tool version manager
    'tig'        # terminal git ui
    'neovim'     # editor
  )

  if [[ $OSTYPE == darwin* ]]; then
    brew_packages+=(
      '1password-cli'
    )
  fi

  if [[ $OSTYPE == linux* ]]; then
    sudo -u linuxbrew bash -c "cd && $BREW install -q ${brew_packages[*]}"
  else
    "$BREW" install -q "${brew_packages[@]}"
  fi

  logSub "Updating installed brew packages..."
  if [[ $OSTYPE == linux* ]]; then
    sudo -u linuxbrew bash -c "cd && $BREW upgrade"
  else
    "$BREW" upgrade
  fi

  # Remove git's included zsh completions in favor of the system completions
  if [[ -f "${HOMEBREW_BASE}/share/zsh/site-functions/_git" ]]; then
    local hb_owner
    hb_owner=$(owner "$HOMEBREW_BASE")
    if [[ "$hb_owner" == "$USER" ]]; then
      rm -f "${HOMEBREW_BASE}/share/zsh/site-functions/_git"
    else
      sudo rm -f "${HOMEBREW_BASE}/share/zsh/site-functions/_git"
    fi
  fi
}

# Update neovim plugins
dotfiles-nvim() {
  if ! command_exists nvim; then
    if [[ $INSTALL == 0 ]]; then
      warn "Neovim not installed"
      return
    fi

    brew install neovim
  fi

  log "Updating neovim resources..."

  logSub "Updating plugins..."
  nvim --headless "+Lazy! sync" +qa

  logSub "Updating language servers..."
  nvim --headless -c "autocmd User MasonUpgradeComplete qall" -c 'MasonUpgrade'

  logSub "Updating treesitter parsers..."
  nvim --headless -c 'TSUpdateSync | lua print("\n") io.flush()' +qa
}

# Update zsh plugins
dotfiles-zsh() {
  log "Updating zsh plugins..."

  if [[ -z "$ZPLUGDIR" ]]; then
    err "ZPLUGDIR not defined"
    return
  fi

  local out=""
  local head=""

  for plugin in "${ZPLUGDIR}"/*/*; do
    [[ -e "$plugin" ]] || continue
    [[ -d "$plugin" ]] || continue
    
    head=$(git -C "$plugin" rev-parse HEAD)
    if ! out=$(git -C "$plugin" pull -q --recurse-submodules 2>&1); then
      err "Error updating ${plugin}"
      err "$out"
      continue
    fi
    if ! out=$(git -C "$plugin" submodule update --remote 2>&1); then
      err "Error updating ${plugin}"
      err "$out"
      continue
    fi
    local new_head
    new_head=$(git -C "$plugin" rev-parse HEAD)
    if [[ "$new_head" != "$head" ]]; then
      local parent
      local basename
      parent=$(basename "$(dirname "$plugin")")
      basename=$(basename "$plugin")
      logSub "Updated ${parent}/${basename}"
    fi
  done

  log "Updating shell completions..."

  makedir "${ZDATADIR}/functions"

  if command_exists op; then
    op completion zsh > "${ZDATADIR}/functions/_op"
  fi

  if command_exists mise; then
    mise complete --shell zsh > "${ZDATADIR}/functions/_mise"
  fi

  if command_exists orb; then
    orb completion zsh > "${ZDATADIR}/functions/_orb"
  fi
}

# Update global npm packages
dotfiles-node() {
  log "Updating node..."

  if ! command_exists npm; then
    if [[ $INSTALL == 0 ]]; then
      warn "Node not installed"
      return
    fi

    brew install node
  fi

  logSub "Updating package managers..."

  if command_exists pnpm; then
    pnpm self-update -q > /dev/null
  fi

  logSub "Updating global node packages..."

  local outdated
  outdated=$(npm outdated -g --json | jq -r 'to_entries[] | "\(.key)"')

  if [[ -z "$outdated" ]]; then
    logSub "No global packages to update"
    return
  fi

  for pkg in $outdated; do
    logSub "Updating $pkg..."
    npm i -g "${pkg}@latest" > /dev/null
  done
}

# Update bun
dotfiles-bun() {
  if ! command_exists bun; then
    if [[ $INSTALL == 0 ]]; then
      warn "bun not installed"
      return
    fi

    log "Installing bun..."
    curl -fsSL https://bun.com/install | bash

    log "Intalling bun completions..."
    bun completions
  fi

  log "Updating bun..."
  bun upgrade
}

# Update uv and tools
dotfiles-uv() {
  if ! command_exists uv; then
    if [[ $INSTALL == 0 ]]; then
      warn "uv not installed"
      return
    fi

    log "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | env UV_NO_MODIFY_PATH=1 sh
  fi

  log "Updating uv..."
  uv self update

  log "Updating uv tools..."
  uv tool upgrade --all
}

# ============================================================================
# Main Script
# ============================================================================

cd "$HOME" || exit 1

while (( $# > 0 )); do
  case $1 in
    -h | --help)
      echo 'usage: dotfiles [options] [group]'
      echo
      echo 'Update local environment. All groups are updated by default.'
      echo
      echo 'Options:'
      echo '    -h, --help     Show this help message'
      echo '    -i, --install  Install missing things'
      echo '    <group>        A group to update'
      echo
      echo 'Available groups:'
      echo '    bat            Rebuild bat theme and filetype cache'
      echo '    brew           Update all installed homebrew packages'
      echo '    fish           Update fish plugins and configure fish'
      echo '    home           Update dotfiles and home directories, fixup terminfo database'
      echo '    init           Install brew and core packages'
      echo '    launchd        Link and bootstrap launchd scripts'
      echo '    node           Update global node packages, install defaults'
      echo '    rust           Update rust install'
      echo '    uv             Update uv tools'
      echo '    vim            Update vim plugins'
      echo '    zsh            Update zsh plugins'
      exit 1
      ;;
    -i | --install)
      INSTALL=1
      ;;
    -*)
      echo "Unknown option $1"
      exit 1
      ;;
    *)
      GROUP=$1
      ;;
  esac

  shift
done

if [[ -n "$GROUP" ]]; then
  "dotfiles-${GROUP}"
else
  dotfiles-home
  dotfiles-brew
  dotfiles-node
  dotfiles-bun
  dotfiles-uv
  dotfiles-rust
  dotfiles-bat
  dotfiles-fish

  if [[ $OSTYPE == darwin* ]]; then
    dotfiles-launchd
    dotfiles-mas
  fi
fi

log "Done"
